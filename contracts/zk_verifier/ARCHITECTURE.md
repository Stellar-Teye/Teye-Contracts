# ZK Verifier Architecture & Export Structure

## ğŸ“¦ Module Structure

```
zk_verifier/
â”‚
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ lib.rs              â† Main entry point, public API
â”‚   â”œâ”€â”€ vk.rs               â† Verification key types (canonical)
â”‚   â”œâ”€â”€ verifier.rs         â† Proof verification logic
â”‚   â”œâ”€â”€ helpers.rs          â† Helper utilities
â”‚   â”œâ”€â”€ audit.rs            â† Audit trail
â”‚   â”œâ”€â”€ events.rs           â† Event definitions
â”‚   â””â”€â”€ plonk.rs            â† PLONK verifier
â”‚
â””â”€â”€ tests/
    â”œâ”€â”€ bench_verify.rs     â† Benchmarks
    â”œâ”€â”€ test_nonce_replay.rs â† Nonce tests
    â”œâ”€â”€ test_zk_access.rs   â† Access tests
    â””â”€â”€ test_exports.rs     â† Export verification
```

## ğŸ”„ Type Flow Diagram

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         vk.rs                                â”‚
â”‚                   (Canonical Definitions)                    â”‚
â”‚                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚   G1Point    â”‚  â”‚   G2Point    â”‚  â”‚ VerificationKey  â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚                â”‚                â”‚
             â”‚ re-export      â”‚ re-export      â”‚ re-export
             â–¼                â–¼                â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      verifier.rs                             â”‚
â”‚                                                              â”‚
â”‚  pub use vk::{G1Point, G2Point};                            â”‚
â”‚  pub type VerificationKey = vk::VerificationKey;            â”‚
â”‚                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚    Proof     â”‚  â”‚  ProofValidationError            â”‚   â”‚
â”‚  â”‚  (uses G1,G2)â”‚  â”‚  Bn254Verifier, PoseidonHasher   â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â”‚ re-export all
             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        lib.rs                                â”‚
â”‚                    (Public API Root)                         â”‚
â”‚                                                              â”‚
â”‚  pub use vk::{G1Point, G2Point, VerificationKey};          â”‚
â”‚  pub use verifier::{Proof, Bn254Verifier, ...};            â”‚
â”‚  pub use helpers::{ZkAccessHelper, MerkleVerifier};        â”‚
â”‚  pub use audit::{AuditRecord, AuditTrail};                 â”‚
â”‚  pub use events::{AccessRejectedEvent};                    â”‚
â”‚                                                              â”‚
â”‚  pub use AccessRequest;        â† Defined in lib.rs         â”‚
â”‚  pub use ContractError;        â† Defined in lib.rs         â”‚
â”‚  pub use ZkVerifierContractClient;  â† Generated by SDK     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â”‚ accessible to
             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Test Files                                â”‚
â”‚                                                              â”‚
â”‚  use zk_verifier::{G1Point, AccessRequest, ...};           â”‚
â”‚  use zk_verifier::vk::{G1Point, G2Point};                  â”‚
â”‚  use zk_verifier::verifier::{Proof, G1Point};              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ¯ Import Resolution Paths

### Path 1: Root Import
```rust
use zk_verifier::G1Point;
```
**Resolution**: lib.rs â†’ vk.rs â†’ G1Point âœ…

### Path 2: Module Import (vk)
```rust
use zk_verifier::vk::G1Point;
```
**Resolution**: lib.rs â†’ vk module â†’ G1Point âœ…

### Path 3: Module Import (verifier)
```rust
use zk_verifier::verifier::G1Point;
```
**Resolution**: lib.rs â†’ verifier module â†’ re-export from vk â†’ G1Point âœ…

**All paths lead to the same type!** ğŸ‰

## ğŸ”§ Before vs After

### Before (Broken) âŒ
```
vk.rs:
  - G1Point âœ“
  - G2Point âœ“

verifier.rs:
  - G1Point âœ— (duplicate!)
  - G2Point âœ— (duplicate!)
  - Proof âœ“

lib.rs:
  - pub use verifier::{G1Point, G2Point} âœ— (wrong source!)
  - AccessRequest not exported âœ—
  - ContractError not exported âœ—
  - ZkVerifierContractClient not exported âœ—
```

### After (Fixed) âœ…
```
vk.rs:
  - G1Point âœ“ (canonical)
  - G2Point âœ“ (canonical)

verifier.rs:
  - pub use vk::{G1Point, G2Point} âœ“ (re-export)
  - Proof âœ“

lib.rs:
  - pub use vk::{G1Point, G2Point} âœ“ (from canonical source)
  - pub use AccessRequest âœ“
  - pub use ContractError âœ“
  - pub use ZkVerifierContractClient âœ“
```

## ğŸ“Š Export Hierarchy

```
lib.rs (Public API)
â”œâ”€â”€ From vk module
â”‚   â”œâ”€â”€ G1Point
â”‚   â”œâ”€â”€ G2Point
â”‚   â””â”€â”€ VerificationKey
â”‚
â”œâ”€â”€ From verifier module
â”‚   â”œâ”€â”€ Proof
â”‚   â”œâ”€â”€ Bn254Verifier
â”‚   â”œâ”€â”€ PoseidonHasher
â”‚   â”œâ”€â”€ ProofValidationError
â”‚   â””â”€â”€ ZkVerifier (trait)
â”‚
â”œâ”€â”€ From helpers module
â”‚   â”œâ”€â”€ ZkAccessHelper
â”‚   â””â”€â”€ MerkleVerifier
â”‚
â”œâ”€â”€ From audit module
â”‚   â”œâ”€â”€ AuditRecord
â”‚   â””â”€â”€ AuditTrail
â”‚
â”œâ”€â”€ From events module
â”‚   â””â”€â”€ AccessRejectedEvent
â”‚
â””â”€â”€ Defined in lib.rs
    â”œâ”€â”€ AccessRequest
    â”œâ”€â”€ ContractError
    â”œâ”€â”€ BatchVerificationSummary
    â”œâ”€â”€ BatchAccessAuditEvent
    â””â”€â”€ ZkVerifierContractClient (generated)
```

## ğŸ§© Type Dependencies

```
AccessRequest
â”œâ”€â”€ uses: Address (soroban_sdk)
â”œâ”€â”€ uses: BytesN<32> (soroban_sdk)
â”œâ”€â”€ uses: Proof (verifier.rs)
â”‚   â”œâ”€â”€ uses: G1Point (vk.rs)
â”‚   â””â”€â”€ uses: G2Point (vk.rs)
â””â”€â”€ uses: Vec<BytesN<32>> (soroban_sdk)

Proof
â”œâ”€â”€ field a: G1Point (vk.rs)
â”œâ”€â”€ field b: G2Point (vk.rs)
â””â”€â”€ field c: G1Point (vk.rs)

VerificationKey
â”œâ”€â”€ field alpha_g1: G1Point (vk.rs)
â”œâ”€â”€ field beta_g2: G2Point (vk.rs)
â”œâ”€â”€ field gamma_g2: G2Point (vk.rs)
â”œâ”€â”€ field delta_g2: G2Point (vk.rs)
â””â”€â”€ field ic: Vec<G1Point> (vk.rs)
```

## ğŸ¨ Design Principles

### 1. Single Source of Truth
- G1Point and G2Point defined ONLY in vk.rs
- All other modules re-export or import from vk.rs

### 2. Layered Exports
- vk.rs: Canonical definitions
- verifier.rs: Re-exports + Proof
- lib.rs: Complete public API

### 3. Import Flexibility
- Users can import from root or submodules
- All paths resolve to same types
- No ambiguity or conflicts

### 4. Backward Compatibility
- All changes are additive
- No breaking changes
- Existing code continues to work

## ğŸ” Verification

To verify the architecture is correct:

```bash
# Check that all modules compile
cargo check -p zk_verifier

# Check that tests can import everything
cargo check -p zk_verifier --tests

# Run export verification test
cargo test -p zk_verifier --test test_exports
```

## ğŸ“ Summary

**Key Achievement**: Clean, hierarchical export structure with no duplication, enabling flexible imports while maintaining type safety and backward compatibility.

**Result**: All test files compile successfully! âœ…
