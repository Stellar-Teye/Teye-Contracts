name: Deploy Testnet

on:
  push:
    branches: [master]
    paths:
      - "contracts/**"
      - "scripts/**"
      - ".github/workflows/deploy-testnet.yml"
  workflow_dispatch:
    inputs:
      contract:
        description: "Contract to deploy (folder name under contracts/)"
        required: false
        default: "vision_records"

concurrency:
  group: deploy-testnet
  cancel-in-progress: false

env:
  RUST_VERSION: "1.92.0"
  SOROBAN_VERSION: "23.1.4"

jobs:
  deploy:
    name: Deploy to Testnet
    runs-on: ubuntu-latest
    environment: testnet
    steps:
      - uses: actions/checkout@v4

      - name: Install system dependencies
        run: sudo apt-get update && sudo apt-get install -y libdbus-1-dev pkg-config libudev-dev libhidapi-dev

      - uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: ${{ env.RUST_VERSION }}
          targets: wasm32-unknown-unknown

      - name: Install Soroban CLI
        run: cargo install --locked --version ${{ env.SOROBAN_VERSION }} soroban-cli

      - name: Configure Soroban testnet
        run: |
          soroban config network add testnet \
            --rpc-url https://soroban-testnet.stellar.org:443 \
            --network-passphrase "Test SDF Network ; September 2015" \
            2>/dev/null || true

      - name: Deploy
        id: deploy
        env:
          GITHUB_CONTRACT_INPUT: ${{ github.event.inputs.contract }}
        run: |
          chmod +x scripts/deploy.sh scripts/deploy_testnet.sh

          CONTRACT="${GITHUB_CONTRACT_INPUT:-vision_records}"
          echo "Deploying: $CONTRACT"

          OUTPUT="$(./scripts/deploy_testnet.sh "$CONTRACT")"
          echo "$OUTPUT"

          CONTRACT_ID=$(echo "$OUTPUT" | sed -n 's/^VERIFIED_CONTRACT_ID=//p')
          if [ -z "$CONTRACT_ID" ]; then
            echo "Failed to parse VERIFIED_CONTRACT_ID"
            exit 1
          fi

          echo "contract_name=$CONTRACT" >> "$GITHUB_OUTPUT"
          echo "contract_id=$CONTRACT_ID" >> "$GITHUB_OUTPUT"

      - name: Deployment report
        run: |
          echo "## Testnet Deployment" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "| Field | Value |" >> "$GITHUB_STEP_SUMMARY"
          echo "|-------|-------|" >> "$GITHUB_STEP_SUMMARY"
          echo "| Contract | \`${{ steps.deploy.outputs.contract_name }}\` |" >> "$GITHUB_STEP_SUMMARY"
          echo "| Network  | \`testnet\` |" >> "$GITHUB_STEP_SUMMARY"
          echo "| ID       | \`${{ steps.deploy.outputs.contract_id }}\` |" >> "$GITHUB_STEP_SUMMARY"
          echo "| Trigger  | \`${{ github.event_name }}\` |" >> "$GITHUB_STEP_SUMMARY"

      - name: Notify Slack (optional)
        if: success() && env.SLACK_WEBHOOK_URL != ''
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          curl -sf -X POST -H 'Content-type: application/json' \
            --data "{\"text\":\"Testnet deploy: ${{ steps.deploy.outputs.contract_name }} â†’ ${{ steps.deploy.outputs.contract_id }}\"}" \
            "$SLACK_WEBHOOK_URL"
