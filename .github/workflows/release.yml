name: Release

on:
  push:
    branches: [master]
  workflow_dispatch:

permissions:
  contents: write

concurrency:
  group: release-${{ github.ref }}
  cancel-in-progress: false

env:
  RUST_VERSION: "1.92.0"
  NODE_VERSION: "20"

jobs:
  # ── Gate: CI must have passed on this commit ─────────────────
  preflight:
    name: Pre-flight Checks
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install system dependencies
        run: sudo apt-get update && sudo apt-get install -y libdbus-1-dev pkg-config libudev-dev libhidapi-dev

      - uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: ${{ env.RUST_VERSION }}
          components: clippy, rustfmt
          targets: wasm32-unknown-unknown

      - uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            target/
          key: ${{ runner.os }}-release-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: ${{ runner.os }}-release-

      - name: Verify formatting
        run: cargo fmt --all -- --check

      - name: Verify Clippy
        run: cargo clippy --all-targets --all-features -- -D warnings

      - name: Run tests
        run: cargo test --all --no-fail-fast

      - name: Build WASM
        run: cargo build --target wasm32-unknown-unknown --release

  # ── Semantic release ─────────────────────────────────────────
  release:
    name: Semantic Release
    runs-on: ubuntu-latest
    needs: [preflight]
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Fetch tags
        run: git fetch --force --tags

      - name: Configure git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

      - uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: ${{ env.RUST_VERSION }}
          targets: wasm32-unknown-unknown

      - name: Install system dependencies
        run: sudo apt-get update && sudo apt-get install -y libdbus-1-dev pkg-config libudev-dev libhidapi-dev

      - name: Build release artifacts
        run: |
          chmod +x scripts/build_release_artifacts.sh
          ./scripts/build_release_artifacts.sh

      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Create semantic-release config
        run: |
          cat > .releaserc.json <<'EOF'
          {
            "branches": ["master"],
            "tagFormat": "v${version}",
            "plugins": [
              ["@semantic-release/commit-analyzer", { "preset": "conventionalcommits" }],
              ["@semantic-release/release-notes-generator", { "preset": "conventionalcommits" }],
              ["@semantic-release/changelog", { "changelogFile": "CHANGELOG.md" }],
              ["@semantic-release/exec", {
                "prepareCmd": "./scripts/prepare_release_version.sh ${nextRelease.version}",
                "publishCmd": "./scripts/generate_release_notes.sh ${nextRelease.version} ${nextRelease.gitTag}"
              }],
              ["@semantic-release/github", {
                "successComment": false,
                "failComment": false,
                "releasedLabels": false,
                "assets": [
                  { "path": "dist/*.wasm", "label": "Contract binaries" },
                  { "path": "dist/SHA256SUMS.txt", "label": "Artifact checksums" },
                  { "path": "dist/RELEASE_NOTES.md", "label": "Release notes" }
                ]
              }],
              ["@semantic-release/git", {
                "assets": ["CHANGELOG.md", "Cargo.toml"],
                "message": "chore(release): ${nextRelease.version} [skip ci]\n\n${nextRelease.notes}"
              }]
            ]
          }
          EOF

      - name: Run semantic-release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          npx -y \
            -p semantic-release \
            -p @semantic-release/changelog \
            -p @semantic-release/commit-analyzer \
            -p @semantic-release/exec \
            -p @semantic-release/git \
            -p @semantic-release/github \
            -p @semantic-release/release-notes-generator \
            -p conventional-changelog-conventionalcommits \
            semantic-release
