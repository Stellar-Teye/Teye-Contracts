name: Release Management

on:
  push:
    branches:
      - master
  workflow_dispatch:

permissions:
  contents: write

concurrency:
  group: release-${{ github.ref }}
  cancel-in-progress: false

env:
  RUST_VERSION: "1.92.0"
  NODE_VERSION: "20"

jobs:
  release:
    name: Semantic Release
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Fetch tags
        run: git fetch --force --tags

      - name: Configure git identity
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: ${{ env.RUST_VERSION }}
          targets: wasm32-unknown-unknown

      - name: Build release artifacts
        run: ./scripts/build_release_artifacts.sh

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Create semantic-release config
        run: |
          cat > .releaserc.json <<'EOF'
          {
            "branches": ["master"],
            "tagFormat": "v${version}",
            "plugins": [
              ["@semantic-release/commit-analyzer", { "preset": "conventionalcommits" }],
              ["@semantic-release/release-notes-generator", { "preset": "conventionalcommits" }],
              ["@semantic-release/changelog", { "changelogFile": "CHANGELOG.md" }],
              ["@semantic-release/exec", {
                "prepareCmd": "./scripts/prepare_release_version.sh ${nextRelease.version}",
                "publishCmd": "./scripts/generate_release_notes.sh ${nextRelease.version} ${nextRelease.gitTag}"
              }],
              ["@semantic-release/github", {
                "successComment": false,
                "failComment": false,
                "releasedLabels": false,
                "assets": [
                  { "path": "dist/*.wasm", "label": "Contract binaries" },
                  { "path": "dist/SHA256SUMS.txt", "label": "Artifact checksums" },
                  { "path": "dist/RELEASE_NOTES.md", "label": "Release notes" }
                ]
              }],
              ["@semantic-release/git", {
                "assets": ["CHANGELOG.md", "Cargo.toml"],
                "message": "chore(release): ${nextRelease.version} [skip ci]\n\n${nextRelease.notes}"
              }]
            ]
          }
          EOF

      - name: Run semantic release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          npx -y \
            -p semantic-release \
            -p @semantic-release/changelog \
            -p @semantic-release/commit-analyzer \
            -p @semantic-release/exec \
            -p @semantic-release/git \
            -p @semantic-release/github \
            -p @semantic-release/release-notes-generator \
            -p conventional-changelog-conventionalcommits \
            semantic-release
