name: Deploy Production

on:
  workflow_dispatch:
    inputs:
      contract:
        description: "Contract to deploy (folder name under contracts/)"
        required: true
        default: "vision_records"
      admin_address:
        description: "Permanent admin address (least-privilege deployment)"
        required: true
      release_tag:
        description: "Git tag of the release to deploy (e.g. v1.3.0)"
        required: true

concurrency:
  group: deploy-production
  cancel-in-progress: false

env:
  RUST_VERSION: "1.92.0"
  SOROBAN_VERSION: "23.1.4"

jobs:
  # ── Validate inputs ──────────────────────────────────────────
  validate:
    name: Validate Release
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.release_tag }}

      - name: Verify tag exists
        run: |
          if ! git rev-parse "${{ github.event.inputs.release_tag }}" >/dev/null 2>&1; then
            echo "Tag ${{ github.event.inputs.release_tag }} not found"
            exit 1
          fi
          echo "Deploying tag: ${{ github.event.inputs.release_tag }}"

  # ── Build from release tag ───────────────────────────────────
  build:
    name: Build from Release Tag
    runs-on: ubuntu-latest
    needs: [validate]
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.release_tag }}

      - name: Install system dependencies
        run: sudo apt-get update && sudo apt-get install -y libdbus-1-dev pkg-config libudev-dev libhidapi-dev

      - uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: ${{ env.RUST_VERSION }}
          targets: wasm32-unknown-unknown

      - name: Build release artifacts
        run: |
          chmod +x scripts/build_release_artifacts.sh
          ./scripts/build_release_artifacts.sh

      - name: Verify WASM checksums
        run: |
          cd dist
          sha256sum -c SHA256SUMS.txt
          echo "All checksums verified."

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: production-wasm
          path: dist/
          retention-days: 30

  # ── Deploy with approval ─────────────────────────────────────
  deploy:
    name: Deploy to Mainnet
    runs-on: ubuntu-latest
    needs: [build]
    environment: production   # Requires environment protection rules
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.release_tag }}

      - name: Install system dependencies
        run: sudo apt-get update && sudo apt-get install -y libdbus-1-dev pkg-config libudev-dev libhidapi-dev

      - uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: ${{ env.RUST_VERSION }}
          targets: wasm32-unknown-unknown

      - name: Install Soroban CLI
        run: cargo install --locked --version ${{ env.SOROBAN_VERSION }} soroban-cli

      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          name: production-wasm
          path: dist/

      - name: Deploy to mainnet
        id: deploy
        env:
          CONTRACT: ${{ github.event.inputs.contract }}
          ADMIN_ADDRESS: ${{ github.event.inputs.admin_address }}
        run: |
          chmod +x scripts/deploy.sh

          echo "Deploying $CONTRACT to mainnet with admin $ADMIN_ADDRESS"
          OUTPUT="$(./scripts/deploy.sh mainnet "$CONTRACT" --admin "$ADMIN_ADDRESS")"
          echo "$OUTPUT"

          CONTRACT_ID=$(echo "$OUTPUT" | sed -n 's/^DEPLOYMENT_CONTRACT_ID=//p')
          echo "contract_id=$CONTRACT_ID" >> "$GITHUB_OUTPUT"

      - name: Deployment report
        run: |
          echo "## Production Deployment" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "| Field | Value |" >> "$GITHUB_STEP_SUMMARY"
          echo "|-------|-------|" >> "$GITHUB_STEP_SUMMARY"
          echo "| Contract | \`${{ github.event.inputs.contract }}\` |" >> "$GITHUB_STEP_SUMMARY"
          echo "| Network  | \`mainnet\` |" >> "$GITHUB_STEP_SUMMARY"
          echo "| Tag      | \`${{ github.event.inputs.release_tag }}\` |" >> "$GITHUB_STEP_SUMMARY"
          echo "| ID       | \`${{ steps.deploy.outputs.contract_id }}\` |" >> "$GITHUB_STEP_SUMMARY"
          echo "| Admin    | \`${{ github.event.inputs.admin_address }}\` |" >> "$GITHUB_STEP_SUMMARY"

      - name: Notify Slack (optional)
        if: always() && env.SLACK_WEBHOOK_URL != ''
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          DEPLOY_STATUS: ${{ job.status }}
        run: |
          STATUS_EMOJI=$( [ "$DEPLOY_STATUS" = "success" ] && echo "✅" || echo "❌" )
          curl -sf -X POST -H 'Content-type: application/json' \
            --data "{\"text\":\"${STATUS_EMOJI} Production deploy (${{ github.event.inputs.contract }}): ${DEPLOY_STATUS}\"}" \
            "$SLACK_WEBHOOK_URL"
